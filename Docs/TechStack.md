# TechStack — Полный технический стек проекта ScheduleBot

**Версия документа:** 1.0  
**Дата:** 03.12.2025  
**Проект:** Телеграм-бот расписания для студентов AGU

---

## Оглавление

1. [Обзор](#1-обзор)
2. [Требования к окружению](#2-требования-к-окружению)
3. [Основные зависимости (Core)](#3-основные-зависимости-core)
4. [Telegram Bot](#4-telegram-bot)
5. [Web Framework (Admin Panel)](#5-web-framework-admin-panel)
6. [База данных](#6-база-данных)
7. [Планировщик задач](#7-планировщик-задач)
8. [Валидация и настройки](#8-валидация-и-настройки)
9. [Шаблонизатор](#9-шаблонизатор)
10. [Сервер приложений](#10-сервер-приложений)
11. [Утилиты и вспомогательные библиотеки](#11-утилиты-и-вспомогательные-библиотеки)
12. [Разработка и тестирование](#12-разработка-и-тестирование)
13. [Полный requirements.txt](#13-полный-requirementstxt)
14. [Совместимость версий](#14-совместимость-версий)
15. [Структура проекта](#15-структура-проекта)
16. [Переменные окружения](#16-переменные-окружения)

---

## 1. Обзор

Проект представляет собой Telegram-бота для доставки расписания студентам с административной веб-панелью для управления данными. Стек построен на современных асинхронных Python-библиотеках с акцентом на производительность, типизацию и простоту развертывания.

### Ключевые технологические решения:

| Компонент | Технология | Обоснование |
|-----------|------------|-------------|
| Telegram Bot | aiogram 3.x | Современный асинхронный фреймворк с полной поддержкой Bot API |
| Web API | FastAPI | Высокопроизводительный async фреймворк с автодокументацией |
| Database | SQLite + aiosqlite | Легковесная БД без необходимости отдельного сервера |
| Scheduler | APScheduler 4.x | Гибкий планировщик с поддержкой asyncio |
| Validation | Pydantic 2.x | Валидация данных с типизацией |
| Server | Uvicorn | ASGI сервер для FastAPI |

---

## 2. Требования к окружению

### Python
```
Python >= 3.11, < 3.13
```

**Обоснование выбора Python 3.11+:**
- Полная поддержка `asyncio` и `typing` модулей
- Улучшенная производительность (до 25% быстрее 3.10)
- Поддержка `zoneinfo` для работы с часовыми поясами
- Совместимость со всеми выбранными библиотеками

### Операционная система
- Windows 10/11 (разработка)
- Linux (для продакшена на VPS)

---

## 3. Основные зависимости (Core)

### 3.1 Асинхронное ядро

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `anyio` | `>=4.4.0,<5.0.0` | Унифицированный интерфейс для asyncio/trio |
| `asyncio` | встроен | Стандартная библиотека асинхронного программирования |

---

## 4. Telegram Bot

### 4.1 Основной фреймворк

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`aiogram`** | `>=3.15.0,<3.23.0` | Асинхронный фреймворк для Telegram Bot API |

**Зависимости aiogram (устанавливаются автоматически):**

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `aiohttp` | `>=3.9.0,<3.12.0` | Асинхронный HTTP клиент/сервер |
| `aiofiles` | `>=23.0.0,<24.2.0` | Асинхронная работа с файлами |
| `magic-filter` | `>=1.0.12` | Фильтры для обработки сообщений |
| `certifi` | `>=2023.7.0` | SSL сертификаты |

### 4.2 Дополнительные extras для aiogram

```bash
pip install aiogram[fast]  # Включает uvloop для улучшенной производительности
```

| Extra | Библиотеки | Описание |
|-------|------------|----------|
| `fast` | `uvloop`, `aiodns` | Ускоренный event loop и DNS резолвер |

### 4.3 Хранение состояний FSM

Для MVP используется встроенное хранилище в памяти (`MemoryStorage`). При необходимости масштабирования:

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `redis` | `>=5.0.0,<5.3.0` | *(опционально)* Redis клиент для FSM Storage |

---

## 5. Web Framework (Admin Panel)

### 5.1 FastAPI и экосистема

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`fastapi`** | `>=0.115.0,<0.123.0` | Web фреймворк для API и админ-панели |
| `starlette` | `>=0.38.0,<0.42.0` | ASGI фреймворк (зависимость FastAPI) |

### 5.2 Установка с extras

```bash
pip install "fastapi[standard]"  # Включает uvicorn, httpx, jinja2 и другие
```

| Extra | Библиотеки | Описание |
|-------|------------|----------|
| `standard` | `uvicorn[standard]`, `httpx`, `jinja2`, `python-multipart` | Стандартный набор для веб-приложения |
| `all` | все extras | Все опциональные зависимости |

### 5.3 Формы и загрузка файлов

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `python-multipart` | `>=0.0.9,<0.1.0` | Обработка form-data и загрузки файлов |

---

## 6. База данных

### 6.1 SQLite (асинхронный доступ)

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`aiosqlite`** | `>=0.20.0,<0.21.0` | Асинхронный драйвер для SQLite |
| `sqlite3` | встроен | Стандартная библиотека Python |

### 6.2 Путь к БД
```
./data/schedule.db
```

### 6.3 Альтернатива (при масштабировании)

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `sqlalchemy[asyncio]` | `>=2.0.0,<3.0.0` | *(опционально)* ORM с async поддержкой |
| `asyncpg` | `>=0.29.0` | *(опционально)* PostgreSQL драйвер |

---

## 7. Планировщик задач

### 7.1 APScheduler 4.x

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`apscheduler`** | `>=4.0.0a5,<5.0.0` | Планировщик задач с asyncio поддержкой |

**Примечание:** APScheduler 4.x находится в alpha-версии, но стабилен для использования. Для продакшена можно использовать APScheduler 3.x:

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `apscheduler` | `>=3.10.4,<4.0.0` | Стабильная версия планировщика |

### 7.2 Типы триггеров

- `IntervalTrigger` — для напоминаний за 5 минут
- `CronTrigger` — для утренней рассылки в 08:00 MSK

### 7.3 Конфигурация планировщика

```python
from apscheduler import AsyncScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.triggers.interval import IntervalTrigger

scheduler = AsyncScheduler()
```

---

## 8. Валидация и настройки

### 8.1 Pydantic 2.x

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`pydantic`** | `>=2.7.0,<2.11.0` | Валидация данных с типизацией |
| **`pydantic-settings`** | `>=2.3.0,<3.0.0` | Управление настройками из ENV |

### 8.2 Особенности Pydantic 2.x
- Быстрая валидация через pydantic-core (Rust)
- Поддержка Python 3.11+ type hints
- Совместимость с FastAPI

### 8.3 Пример использования

```python
from pydantic import BaseModel, Field
from pydantic_settings import BaseSettings, SettingsConfigDict

class Settings(BaseSettings):
    bot_token: str
    admin_tg_id: int
    admin_password: str
    timezone: str = "Europe/Moscow"
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8"
    )
```

---

## 9. Шаблонизатор

### 9.1 Jinja2

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`jinja2`** | `>=3.1.3,<4.0.0` | Шаблонизатор для HTML админ-панели |
| `markupsafe` | `>=2.1.5` | Безопасное экранирование (зависимость Jinja2) |

### 9.2 Использование
- Рендеринг HTML страниц админ-панели
- Формирование текстовых сообщений бота (опционально)

---

## 10. Сервер приложений

### 10.1 Uvicorn

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`uvicorn`** | `>=0.30.0,<0.32.0` | ASGI сервер для FastAPI |

### 10.2 Установка с extras

```bash
pip install "uvicorn[standard]"
```

| Extra | Библиотеки | Описание |
|-------|------------|----------|
| `standard` | `uvloop`, `httptools`, `watchfiles`, `websockets` | Оптимизированный набор |

### 10.3 Запуск

```bash
# Разработка
uvicorn admin_app:app --reload --host 127.0.0.1 --port 8000

# Продакшен
uvicorn admin_app:app --host 0.0.0.0 --port 8000 --workers 1
```

---

## 11. Утилиты и вспомогательные библиотеки

### 11.1 Работа с окружением

| Библиотека | Версия | Описание |
|------------|--------|----------|
| **`python-dotenv`** | `>=1.0.0,<2.0.0` | Загрузка переменных из .env файла |

### 11.2 Работа с датами и временем

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `zoneinfo` | встроен (Python 3.9+) | Работа с часовыми поясами |
| `datetime` | встроен | Работа с датой и временем |

### 11.3 Типизация

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `typing-extensions` | `>=4.10.0,<5.0.0` | Расширения для типизации |

### 11.4 Логирование

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `logging` | встроен | Стандартная библиотека логирования |
| `loguru` | `>=0.7.2,<1.0.0` | *(опционально)* Улучшенное логирование |

---

## 12. Разработка и тестирование

### 12.1 Тестирование

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `pytest` | `>=8.0.0,<9.0.0` | Фреймворк для тестирования |
| `pytest-asyncio` | `>=0.23.0,<1.0.0` | Асинхронные тесты |
| `pytest-cov` | `>=5.0.0,<6.0.0` | Покрытие кода тестами |
| `httpx` | `>=0.27.0,<1.0.0` | Тестирование HTTP эндпоинтов |

### 12.2 Линтинг и форматирование

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `ruff` | `>=0.5.0,<1.0.0` | Быстрый линтер и форматтер |
| `mypy` | `>=1.10.0,<2.0.0` | Статический анализ типов |

### 12.3 Pre-commit hooks

| Библиотека | Версия | Описание |
|------------|--------|----------|
| `pre-commit` | `>=3.7.0,<4.0.0` | Git hooks для проверки кода |

---

## 13. Полный requirements.txt

### 13.1 Основной requirements.txt

```txt
# ===============================================
# ScheduleBot - Production Dependencies
# Python >= 3.11, < 3.13
# ===============================================

# === Telegram Bot ===
aiogram>=3.15.0,<3.23.0

# === Web Framework ===
fastapi>=0.115.0,<0.123.0
uvicorn[standard]>=0.30.0,<0.32.0
python-multipart>=0.0.9,<0.1.0

# === Database ===
aiosqlite>=0.20.0,<0.21.0

# === Scheduler ===
apscheduler>=4.0.0a5,<5.0.0
# Альтернатива (стабильная версия):
# apscheduler>=3.10.4,<4.0.0

# === Validation & Settings ===
pydantic>=2.7.0,<2.11.0
pydantic-settings>=2.3.0,<3.0.0

# === Templates ===
jinja2>=3.1.3,<4.0.0

# === Utilities ===
python-dotenv>=1.0.0,<2.0.0
typing-extensions>=4.10.0,<5.0.0

# === Async Utilities ===
anyio>=4.4.0,<5.0.0
aiofiles>=23.0.0,<24.2.0
```

### 13.2 requirements-dev.txt

```txt
# ===============================================
# ScheduleBot - Development Dependencies
# ===============================================

-r requirements.txt

# === Testing ===
pytest>=8.0.0,<9.0.0
pytest-asyncio>=0.23.0,<1.0.0
pytest-cov>=5.0.0,<6.0.0
httpx>=0.27.0,<1.0.0

# === Linting & Formatting ===
ruff>=0.5.0,<1.0.0
mypy>=1.10.0,<2.0.0

# === Pre-commit ===
pre-commit>=3.7.0,<4.0.0

# === Logging (optional) ===
loguru>=0.7.2,<1.0.0
```

---

## 14. Совместимость версий

### 14.1 Матрица совместимости основных библиотек

| aiogram | FastAPI | Pydantic | aiohttp | Python |
|---------|---------|----------|---------|--------|
| 3.15+ | 0.115+ | 2.7+ | 3.9+ | 3.11+ |
| 3.20+ | 0.120+ | 2.9+ | 3.10+ | 3.11+ |
| 3.22 | 0.122 | 2.10 | 3.11 | 3.11-3.12 |

### 14.2 Известные ограничения

1. **APScheduler 4.x** — alpha версия, для стабильности используйте 3.10.x
2. **aiohttp >= 3.11** — требуется для aiogram 3.20+
3. **Pydantic 2.x** — несовместим с Pydantic 1.x кодом

### 14.3 Проверка совместимости

```bash
pip check
```

---

## 15. Структура проекта

```
AGU_Schedule/
├── app/
│   ├── __init__.py
│   ├── main.py                 # Точка входа приложения
│   ├── config.py               # Конфигурация (pydantic-settings)
│   │
│   ├── bot/
│   │   ├── __init__.py
│   │   ├── bot.py              # Инициализация aiogram Bot и Dispatcher
│   │   ├── handlers/
│   │   │   ├── __init__.py
│   │   │   ├── onboarding.py   # /start, выбор курса/направления
│   │   │   ├── settings.py     # /settings, напоминания, пауза
│   │   │   └── admin.py        # /admin команды
│   │   ├── keyboards/
│   │   │   ├── __init__.py
│   │   │   └── inline.py       # Inline клавиатуры
│   │   ├── middlewares/
│   │   │   └── __init__.py
│   │   └── states/
│   │       ├── __init__.py
│   │       └── onboarding.py   # FSM состояния
│   │
│   ├── web/
│   │   ├── __init__.py
│   │   ├── admin_app.py        # FastAPI приложение
│   │   ├── routes/
│   │   │   ├── __init__.py
│   │   │   ├── auth.py         # Авторизация админа
│   │   │   ├── pairs.py        # CRUD пар
│   │   │   ├── directions.py   # Управление направлениями
│   │   │   ├── broadcast.py    # Рассылка
│   │   │   └── logs.py         # Логи доставки
│   │   ├── templates/
│   │   │   ├── base.html
│   │   │   ├── login.html
│   │   │   ├── dashboard.html
│   │   │   ├── pairs/
│   │   │   └── ...
│   │   └── static/
│   │       ├── css/
│   │       └── js/
│   │
│   ├── scheduler/
│   │   ├── __init__.py
│   │   ├── scheduler.py        # APScheduler конфигурация
│   │   ├── jobs/
│   │   │   ├── __init__.py
│   │   │   ├── morning.py      # Утренняя рассылка 08:00 MSK
│   │   │   └── reminder.py     # Напоминания за 5 минут
│   │   └── delivery.py         # Логика доставки сообщений
│   │
│   ├── db/
│   │   ├── __init__.py
│   │   ├── database.py         # Подключение к SQLite
│   │   ├── models.py           # Pydantic модели
│   │   ├── schema.sql          # SQL схема
│   │   └── queries/
│   │       ├── __init__.py
│   │       ├── users.py
│   │       ├── pairs.py
│   │       └── delivery.py
│   │
│   └── utils/
│       ├── __init__.py
│       ├── timezone.py         # Работа с Europe/Moscow
│       └── message_builder.py  # Форматирование сообщений
│
├── data/
│   └── schedule.db             # SQLite база данных
│
├── logs/
│   └── app.log                 # Логи приложения
│
├── scripts/
│   ├── init_db.py              # Инициализация БД
│   └── seed_data.py            # Заполнение начальных данных
│
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_bot/
│   ├── test_web/
│   └── test_scheduler/
│
├── Docs/
│   ├── PRD.md
│   ├── AppMap.md
│   └── TechStack.md            # Этот документ
│
├── .env.example                # Пример переменных окружения
├── .env                        # Локальные переменные (не в git)
├── .gitignore
├── requirements.txt
├── requirements-dev.txt
├── pyproject.toml              # Конфигурация проекта
└── README.md
```

---

## 16. Переменные окружения

### 16.1 .env.example

```env
# ===============================================
# ScheduleBot Environment Variables
# ===============================================

# === Telegram Bot ===
BOT_TOKEN=your_bot_token_here
ADMIN_TG_ID=123456789

# === Admin Panel ===
ADMIN_PASSWORD=your_secure_password_here
SECRET_KEY=your_secret_key_for_sessions

# === Database ===
DATABASE_PATH=./data/schedule.db

# === Timezone ===
TIMEZONE=Europe/Moscow

# === Server ===
HOST=127.0.0.1
PORT=8000
DEBUG=true

# === Scheduler ===
MORNING_HOUR=8
MORNING_MINUTE=0
REMINDER_MINUTES_BEFORE=5

# === Delivery ===
BATCH_SIZE=30
BATCH_DELAY=0.1
RETRY_ATTEMPTS=1
```

---

## Changelog

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 03.12.2025 | Первоначальная версия TechStack |

---

*Документ подготовлен на основе PRD.md и AppMap.md проекта ScheduleBot.*
