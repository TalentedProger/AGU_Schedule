PRD — MVP: «Телеграм-бот расписания для студентов» (кратко)

Цель: дать студентам ежедневное удобное расписание и оповещения за 5 минут до пары. Админ (ты) заполняет расписание через простой веб-интерфейс.
Аудитория: только студенты вуза. Старт: ~100–200, потенциально до 3500–4500.
Ключевые требования (итог ваших ответов):

Бот на aiogram 3, асинхронный.

БД: SQLite (MVP).

Уведомление «ежедневное» — текстовое сообщение в 08:00 МСК ровно.

При включённом режиме напоминаний — дополнительные уведомления за 5 минут до каждой пары.

Пользователь хранит ник Telegram в БД; при первом запуске бот предлагает ввести имя, далее обращаться по введённому имени.

Пользователь выбирает 1 курс → 1 направление; нельзя подписаться на несколько.

Админ-сайт локальный (только для тебя) — аутентификация по Telegram ID (или пароль), доступ только админу.

Админ может массово назначать одну пару на несколько направлений (чекбоксы).

Веб-интерфейс — только инструменты для CRUD пар (создать/редактировать/удалить), тестовый предпросмотр рассылки и массовая рассылка (/admin → рассылка).

Формат сообщений — только текст, преподаватель — полное ФИО. Дополнительные поля (ссылки) видны в админке и включаются в сообщения только если заполнены.

Возможность приостановить рассылку для отдельного пользователя.

Кнопка «поделиться ботом».

Логи доставки минимальные: попытка повторной отправки 1 раз при ошибке; статистика просмотров (ограниченная).

Никакой автопарсинг PDF, никаких экспортов, никаких ролей кроме «админ» и «студент».

Поведение бота — сценарии и тексты
/start — онбординг

Получаем Telegram username (ник). Если есть — предлагаем отредактировать (опционально). Затем просим ввести имя (имя, как бот будет к нему обращаться).

Выбор курса (1–4) — инлайн клавиатура.

После выбора курса — обновляем инлайн клавиатуру списком направлений для этого курса.

После выбора — показываем проверочное сообщение:

Отлично, почти все готово! Проверьте, всё ли верно?
Имя: Иван
Курс: 2
Направление: МОАИС

[Все верно!] [Заново]


Если нажали «Все верно!» — отправка:

Поздравляем! Вы будете получать сообщение о парах ежедневно в 08:00 (МСК).
В настройках вы можете включить режим оповещений за 5 минут до каждой пары.


Кнопка «Заново» — возвращает к выбору курса/направления.

/settings (меню настроек)

Переключатель: «Оповещения за 5 минут: Вкл/Выкл».

Кнопка: «Приостановить рассылку» (указать даты — для простоты MVP: на X дней или до возобновления).

Кнопка: «Поделиться ботом» — стандартная ссылка.

Утреннее сообщение (пример)
Доброе утро, Ivan!
Понедельник (02.12.2025)

1 пара: Математический анализ
Аудитория: 312
Тип: Семинар
Преподаватель: Иванов Иван Иванович

2 пара: ...


— Отправляется в 08:00 МСК (время хранится и обрабатывается в timezone-aware формате).

Напоминание за 5 минут

Если включено:

Через 5 минут — 1 пара: Математический анализ.
Аудитория: 312
Тип: Семинар
Преподаватель: Иванов И.И.


— Отправляется только если пара есть и пользователь включил напоминания. Если включил режим в последние 5 минут до пары — уведомление отправлять (согласно вашему ответу).

/admin (в чате админа)

Только для Telegram ID админа.

Меню: «Редактировать расписание (сайт)», «Рассылка всем», «Тестовая рассылка».

«Рассылка всем» — ввод текста, опционально фото; подтверждение перед отправкой и возможность пропустить фото.

Модель данных (SQLite) — схема таблиц (SQL)

Ниже — базовый набор таблиц для MVP. Данные времени — timezone-aware (ISO8601 UTC).

-- users: студенты
CREATE TABLE users (
  id INTEGER PRIMARY KEY,           -- локальный id
  tg_id INTEGER UNIQUE NOT NULL,    -- Telegram user id
  tg_username TEXT,                 -- @username (ник)
  name TEXT NOT NULL,               -- введённое имя
  course INTEGER NOT NULL,          -- 1..4
  direction_id INTEGER NOT NULL,    -- ссылка на directions
  remind_before BOOLEAN DEFAULT 0,  -- включены уведомления за 5 минут
  paused_until TEXT DEFAULT NULL,   -- ISO date string если приостановленo
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- directions: направления
CREATE TABLE directions (
  id INTEGER PRIMARY KEY,
  name TEXT NOT NULL,
  course INTEGER NOT NULL
);

-- time_slots: фиксированные слоты (1..5) и их время (локальное)
CREATE TABLE time_slots (
  id INTEGER PRIMARY KEY,   -- 1..5
  start_time TEXT NOT NULL, -- "09:00" (local) — использовать вместе с day/date
  end_time TEXT NOT NULL
);

-- pairs: одна пара-шаблон (предназначена для определённого дня недели)
CREATE TABLE pairs (
  id INTEGER PRIMARY KEY,
  title TEXT NOT NULL,
  teacher TEXT,         -- полное ФИО
  room TEXT,
  type TEXT,            -- лекция/семинар/практика
  extra_link TEXT,      -- опционально, может быть NULL
  day_of_week INTEGER,  -- 0=Monday ... 6=Sunday
  slot_id INTEGER NOT NULL, -- ссылка на time_slots.id
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

-- pair_assignments: связывает pairs с направлениями (многие-ко-многим)
CREATE TABLE pair_assignments (
  id INTEGER PRIMARY KEY,
  pair_id INTEGER NOT NULL,
  direction_id INTEGER NOT NULL,
  FOREIGN KEY(pair_id) REFERENCES pairs(id),
  FOREIGN KEY(direction_id) REFERENCES directions(id)
);

-- delivery_log: минимальная таблица логов отправки
CREATE TABLE delivery_log (
  id INTEGER PRIMARY KEY,
  user_id INTEGER,
  pair_id INTEGER,
  message_type TEXT, -- 'morning' or 'reminder' or 'broadcast'
  status TEXT,       -- 'sent', 'error'
  tg_message_id INTEGER,
  error TEXT,
  ts TEXT DEFAULT CURRENT_TIMESTAMP
);


Заметки:

Структура хранит недельный шаблон: pairs привязана к day_of_week + slot_id (1..5).

Для исключений/замен отдельные таблицы не нужны в MVP.

pair_assignments даёт возможность назначать одну пару на несколько направлений (реализация чекбоксов в админке).

time_slots заполняются один раз согласно времени, которое ты дал:

1: 09:00–10:45, 2: 10:45–12:20, 3: 13:00–14:35, 4: 14:45–16:20, 5: 16:30–18:05.

API / Архитектура бота (aiogram 3) — логика

Запуск и режимы:

Режим разработки: long polling (aiogram.Bot + Aiogram Dispatcher).

Режим прод/локал: long polling запускается в фоне на ПК; для хостинга — лучше VPS/railway; Vercel — не подходит для долгоживущих cron-задач (см. ниже).

Основные компоненты:

bot.py — точка запуска aiogram.

handlers/onboarding.py — обработчики /start, inline клавиатуры выбора курса/направления, кнопки «Все верно!/Заново».

handlers/settings.py — /settings, включение/выключение напоминаний, приостановка.

scheduler.py — планировщик отправки:

Ежедневно в 08:00 МСК: собираем всех пользователей (не приостановленных) → для каждого: получаем их направление и пары на сегодня (day_of_week) → формируем текст и отправляем.

За 5 минут до начала пары: отдельная задача, которая находит пары, начинающиеся через 5 минут (в MSK), и отправляет напоминания только тем пользователям, у которых включено remind_before.

admin_handlers.py — /admin, broadcast, тест.

admin_site/ — веб-панель (см. ниже).

Отправка массовых сообщений — устойчивость и rate limits:

Telegram имеет rate limits. Для стабильной рассылки: разбить пользователей на батчи (например 20–50) и отправлять asyncio.gather по батчам с небольшой задержкой между батчами (напр., 100–500 ms) — MVP: простая backoff/queue:

При ошибке отправки (network error) — одна попытка повторной отправки.

Логируем результат в delivery_log.

Для больших аудиторий (несколько тысяч) — рекомендую использовать очередь/worker (celery/RQ) в будущем, но для MVP — простой батчинг + asyncio.Semaphore ограничит количество параллельных запросов.

Timezone handling:

Хранить все временные события как локальные (slots — 09:00..), но при планировании приводить к UTC с помощью zoneinfo (zone name: Europe/Moscow).

На сервере лучше использовать UTC; для запуска scheduler рассчитывать целевые UTC-времена:

Триггер на 08:00 МСК ⇒ рассчитывать перевод в UTC (MSK = UTC+3, без DST).

Для напоминаний — рассчитывать datetime теперь+5 минут в MSK → сравнивать с парой.

Веб-интерфейс администратора (локальный, только для тебя)

Технологии (предложение MVP):

Backend: FastAPI (Python) — лёгкий, async, простой интегрировать с aiogram.

Frontend: простая админка на HTML (Jinja) или лёгкий React (если предпочтёшь). Для MVP — HTML + Bootstrap будет быстрее.

БД: SQLite (shared file).

HTTPS: для локальной разработки — можно использовать self-signed cert; если будешь разворачивать публично — используй Let’s Encrypt.

Основные страницы/функции:

Вход (auth): проверка TG ID или пароль; если не совпадает — отказ.

Dashboard: сводка (число юзеров, направление/курс).

CRUD пар:

Форма «Создать пару»: title, teacher (ФИО), room, type, day_of_week (пн–вс), slot (1–5), доп.поле link.

Список направлений с чекбоксами (назначить на 1..N направлений).

Кнопка «Протестировать → отправить тестовое сообщение на указанный TG ID» (preview).

Управление time_slots (редактировать времена, но по умолчанию заполни заранее).

Broadcast: /admin → ввод текста, загрузка фото (опционально), кнопка «Отправить всем» с подтверждением и предпросмотром.

Лог отправок (delivery_log) — таблица, фильтрация по дате/статусу.

UX-фишки MVP:

При назначении пары — чекбоксы списком (как просил).

Preview шаблона сообщения «Как оно придёт студенту».

Тестовый режим (отправить одному пользователю) — нужен.

Message templates и примеры (на русском)

Утреннее:

Доброе утро, {name}!
{weekday} ({dd.mm.YYYY})

{for each pair i} {i} пара: {title}
Аудитория: {room}
Тип: {type}
Преподаватель: {teacher}
{end}


Напоминание:

Через 5 минут — {i} пара: {title}
Аудитория: {room}
Тип: {type}
Преподаватель: {teacher}


Broadcast (админ):

[Текст который ввёл админ]


(фото опционально)

План задач MVP (битый список, приоритеты)

A. Базовые — must have

Инициализация проекта (aiogram3, FastAPI, SQLite, env config для token, tz).

Таблицы SQLite + начальные данные (time_slots, directions по курсам).

Handlers: /start — онбординг + выбор курса/направления + сохранение в users.

Morning job: планировщик, формирование и отправка утренних сообщений.

Reminders: логика отправки за 5 минут (включаемая/выключаемая).

Settings handler: включение/выключение напоминаний и приостановка рассылки.

Базовый механизм батчинга и retry=1, логирование в delivery_log.

Админ-панель (локально) — CRUD пар + назначение на направления + тестовое сообщение.

/admin команда в боте — запуск broadcast workflow.

Тесты ручные/интеграционные проверки: пробная база, несколько тестовых пользователей.

B. Улучшения — nice to have
11. Preview сообщений в админке.
12. Минимальная статистика просмотров (реализуется через отслеживание кликов/команд; Telegram не даёт прямого read receipt).
13. HTTPS для админки (self-signed для локали; Let’s Encrypt для внешнего).
14. Экспорт/бэкап SQLite (ручной дамп).

Технические рекомендации и замечания по развёртыванию

Локально (на ПК) — использовать long polling aiogram + uvicorn для FastAPI. Запускать два процесса (или один процесс с uvloop и BackgroundTasks): бот + веб-админка + планировщик.

Vercel — не рекомендую для финальной версии, потому что Vercel — serverless и не подходит для долгоживущих background процессов (scheduler/worker). Если хочешь всё же разместить фронт на Vercel, backend и scheduler лучше держать на VPS / Railway / Render / DigitalOcean droplet. Для MVP — оставь на своём ПК, потом — VPS.

Чтобы scheduler работал при деплое — варианты:

На VPS держать долгоживущий процесс (systemd) с aiogram + scheduler.

Или использовать внешний cron (cron-job.org) который вызывает endpoint /send_morning на твоём API (тогда бот сам обрабатывает отсылку). Это хорошая альтернатива, если хостинг не держит фоновые процессы.

Без Docker — как просил, проект будет запускаться через python -m venv и pip install -r requirements.txt.

Rate limits: при 3500+ пользователях нужно аккуратно батчить отправки и отслеживать HTTP 429. Простая схема: semaphore=20 и delay 0.1–0.3 s между батчами.

Безопасность и приватность

Админ-доступ по Telegram ID (указан вами) + пароль для веб-панели на случай.

Хранится только ник и имя (минимум персональных данных).

При разворачивании публично — обязательно HTTPS (Let’s Encrypt).

Бэкап = ручный дамп sqlite (как просили).

Примеры начальных данных (заполню автоматически при инициализации)

time_slots: id 1..5 с временами, как ты дал.

directions:

course 1: Математика, Мат основы ИИ, ИИ в мат и IT, ПМ, МОАИС, ИБ.

course 2..4: как ты перечислил.